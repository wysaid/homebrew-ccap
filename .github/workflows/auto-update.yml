name: Auto Update Formula

on:
  schedule:
    # Run daily at 00:00 UTC
    - cron: '0 0 * * *'
  workflow_dispatch:
    # Allow manual triggering

permissions:
  contents: write
  pull-requests: write

jobs:
  check-and-update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Get current formula version
        id: current
        run: |
          # Extract semantic version (supports versions like 1.2.0, 1.2.3-beta, 1.3.2)
          CURRENT_VERSION=$(grep -oP 'url "https://github.com/wysaid/CameraCapture/archive/refs/tags/v\K[0-9]+\.[0-9]+\.[0-9]+[0-9a-zA-Z.-]*' ccap.rb || true)
          if [ -z "$CURRENT_VERSION" ]; then
            echo "Error: Could not extract current version from ccap.rb"
            exit 1
          fi
          echo "version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"
          echo "Current version: v$CURRENT_VERSION"

      - name: Get latest release from upstream
        id: upstream
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          if ! LATEST_RELEASE=$(gh api repos/wysaid/CameraCapture/releases/latest --jq '.tag_name' 2>&1); then
            echo "Error: Failed to fetch latest release from upstream"
            exit 1
          fi
          if [ -z "$LATEST_RELEASE" ]; then
            echo "Error: No release tag found"
            exit 1
          fi
          LATEST_VERSION=${LATEST_RELEASE#v}
          echo "version=$LATEST_VERSION" >> "$GITHUB_OUTPUT"
          echo "tag=$LATEST_RELEASE" >> "$GITHUB_OUTPUT"
          echo "Latest upstream version: $LATEST_RELEASE"

      - name: Check if update is needed
        id: check
        run: |
          if [ "${{ steps.current.outputs.version }}" = "${{ steps.upstream.outputs.version }}" ]; then
            echo "No update needed. Current version (${{ steps.current.outputs.version }}) matches upstream."
            echo "needs_update=false" >> "$GITHUB_OUTPUT"
          else
            echo "Update needed: v${{ steps.current.outputs.version }} -> v${{ steps.upstream.outputs.version }}"
            echo "needs_update=true" >> "$GITHUB_OUTPUT"
          fi

      - name: Download tarball and calculate SHA256
        if: steps.check.outputs.needs_update == 'true'
        id: sha256
        run: |
          TAG="${{ steps.upstream.outputs.tag }}"
          URL="https://github.com/wysaid/CameraCapture/archive/refs/tags/${TAG}.tar.gz"
          echo "Downloading: $URL"
          if ! curl -sSfL "$URL" -o source.tar.gz; then
            echo "Error: Failed to download tarball from $URL"
            exit 1
          fi
          SHA256=$(sha256sum source.tar.gz | awk '{print $1}')
          if ! echo "$SHA256" | grep -qE '^[a-f0-9]{64}$'; then
            echo "Error: Invalid SHA256 format: $SHA256"
            exit 1
          fi
          echo "sha256=$SHA256" >> "$GITHUB_OUTPUT"
          echo "SHA256: $SHA256"
          rm source.tar.gz

      - name: Update formula
        if: steps.check.outputs.needs_update == 'true'
        run: |
          NEW_VERSION="${{ steps.upstream.outputs.version }}"
          NEW_SHA256="${{ steps.sha256.outputs.sha256 }}"
          
          # Update version in URL (supports extended versions like 1.2.0-beta)
          sed -i -E "s|url \"https://github.com/wysaid/CameraCapture/archive/refs/tags/v[0-9]+\.[0-9]+\.[0-9]+[0-9a-zA-Z.-]*\.tar\.gz\"|url \"https://github.com/wysaid/CameraCapture/archive/refs/tags/v${NEW_VERSION}.tar.gz\"|" ccap.rb
          
          # Update SHA256 (match exactly 64 hex characters)
          sed -i "s|sha256 \"[a-f0-9]\{64\}\"|sha256 \"${NEW_SHA256}\"|" ccap.rb
          
          # Validate that the version and SHA256 were updated
          if ! grep -q "v${NEW_VERSION}" ccap.rb; then
            echo "Error: Failed to update version in ccap.rb"
            exit 1
          fi
          if ! grep -q "${NEW_SHA256}" ccap.rb; then
            echo "Error: Failed to update SHA256 in ccap.rb"
            exit 1
          fi
          
          echo "Formula updated to v${NEW_VERSION}"
          cat ccap.rb

      - name: Create Pull Request
        if: steps.check.outputs.needs_update == 'true'
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ github.token }}
          commit-message: "Update ccap to v${{ steps.upstream.outputs.version }}"
          title: "Update ccap to v${{ steps.upstream.outputs.version }}"
          body: |
            ## Automated Formula Update

            This PR was automatically created by the auto-update workflow.

            ### Changes
            - **Previous version:** v${{ steps.current.outputs.version }}
            - **New version:** v${{ steps.upstream.outputs.version }}
            - **SHA256:** `${{ steps.sha256.outputs.sha256 }}`

            ### Upstream Release
            - [Release ${{ steps.upstream.outputs.tag }}](https://github.com/wysaid/CameraCapture/releases/tag/${{ steps.upstream.outputs.tag }})

            ---
            *Please review the changes and merge if everything looks correct.*
          branch: release-v${{ steps.upstream.outputs.version }}
          base: main
          labels: |
            automated
            formula-update
